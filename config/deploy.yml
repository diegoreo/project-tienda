# config/deploy.yml
service: tienda-pro

# Imagen Docker
image: diegoreyesdeveloper/tienda-pro

# Builder configuration
builder:
  arch: amd64

# Servidores
servers:
  web:
    hosts: [178.156.216.102]
    options:
      health-cmd: "curl -f http://localhost:3000/up || exit 1"
      health-interval: 10s
      health-timeout: 5s
      health-retries: 3
    proxy:
      app_port: 3000
      host: 178.156.216.102

# Registry (Docker Hub)
registry:
  server: docker.io
  username: diegoreyesdeveloper
  password:
    - KAMAL_REGISTRY_PASSWORD

# SSH
ssh:
  user: deploy

# Variables de entorno
env:
  clear:
    RAILS_ENV: production
    RAILS_LOG_TO_STDOUT: true
  secret:
    - RAILS_MASTER_KEY
    - DATABASE_URL
    - REDIS_URL

# PostgreSQL
accessories:
  db:
    image: postgres:16
    host: 178.156.216.102
    port: 5432
    env:
      clear:
        POSTGRES_USER: tienda_pro
        POSTGRES_DB: tienda_pro_production
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data:/var/lib/postgresql/data

  redis:
    image: redis:7
    host: 178.156.216.102
    port: 6379
    directories:
      - data:/data

# Proxy (Traefik) - Sintaxis correcta
proxy:
  ssl: false
  host: 178.156.216.102
