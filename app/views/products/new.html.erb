<h1>Nuevo Producto</h1>

<%= form_with(model: @product, local: true) do |form| %>


  <!-- Nombre y descripción -->
  <div class="form-group">
    <%= form.label :name, "Nombre del producto" %>
    <%= form.text_field :name, class: "form-control", placeholder: "Ej. CocaCola 600ml" %>
    <%= field_error_messages(@product, :name) %>
  </div>

  <div class="form-group">
    <%= form.label :description, "Descripción" %>
    <%= form.text_area :description, class: "form-control", rows: 3, placeholder: "Describe el producto" %>
    <%= field_error_messages(@product, :description) %>
  </div>

  <!-- Categoría -->
  <div class="form-group">
    <%= form.label :category_id, "Categoría" %>
    <%= form.collection_select :category_id, Category.all, :id, :name, { prompt: "Selecciona una categoría" }, class: "form-control" %>
    <%= field_error_messages(@product, :category_id) %>
  </div>

  <!-- Unidades -->
  <div class="form-group">
    <%= form.label :purchase_unit_id, "Unidad de compra" %>
    <%= form.collection_select :purchase_unit_id, Unit.all, :id, :name, prompt: "Seleccione unidad de compra" %>  
    <%= field_error_messages(@product, :purchase_unit_id) %>
    </div>
    
  <div class="form-group">
    <%= form.label :sale_unit_id, "Unidad de venta" %>
    <%= form.collection_select :sale_unit_id, Unit.all, :id, :name, prompt: "Seleccione unidad de venta" %>  
    <%= field_error_messages(@product, :sale_unit_id) %>
    </div>

<div class="form-group">
  <%= form.label :unit_conversion, "Conversión (unidad compra → unidad venta)" %>
  <div style="display: flex; align-items: center; gap: 1rem;">
    <%= form.number_field :unit_conversion, class: "form-control", step: 1, placeholder: "Ej. 24" %>
    
    <% if form.object.unit_conversion.present? && form.object.stock_quantity.present? %>
      <span style="white-space: nowrap; font-weight: bold;">
        = <%= (form.object.stock_quantity * form.object.unit_conversion).to_i %> <%= form.object.sale_unit&.name || 'unidades' %>
      </span>
    <% else %>
      <span style="white-space: nowrap; color: gray;">
        Ingresa cantidad y conversión
      </span>
    <% end %>
  </div>
  
  <small class="form-text text-muted">
    Ejemplo: Si cada caja trae 24 piezas, escribe 24.
  </small>
  <%= field_error_messages(@product, :unit_conversion) %>
</div>


  <!-- Inventario inicial -->
  <div class="form-group">
    <%= form.label :stock_quantity, "Inventario inicial (en #{form.object.purchase_unit.presence || 'unidad'})" %>
    <%= form.number_field :stock_quantity, class: "form-control", placeholder: "Ej. 10" %>
    <small class="form-text text-muted">
      Ingresa la cantidad inicial en la unidad de compra. Por ejemplo, si compras en cajas, indica cuántas cajas tienes.
    </small>
    <%= field_error_messages(@product, :stock_quantity) %>
  </div>

  <!-- Precio -->
  <div class="form-group">
    <%= form.label :price, "Precio" %>
    <%= form.number_field :price, step: 0.01, class: "form-control", placeholder: "Ej. 20.00" %>
    <%= field_error_messages(@product, :price) %>
  </div>

  <!-- Códigos de barras -->
  <div class="form-group">
    <%= form.fields_for :barcodes do |barcode_form| %>
      <div class="barcode-field">
        <%= barcode_form.label :code, "Código de barras" %>
        <%= barcode_form.text_field :code, class: "form-control", placeholder: "Ej. 7501031311309" %>
        <%= field_error_messages(barcode_form.object, :code) %>
      </div>
    <% end %>
  </div>

  <div class="actions mt-3">
    <%= form.submit "Guardar producto", class: "btn btn-primary" %>
  </div>
<% end %>
