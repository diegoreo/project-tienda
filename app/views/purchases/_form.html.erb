<div class="bg-gray-50 min-h-screen">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    
    <!-- Breadcrumb -->
    <nav class="flex mb-6" aria-label="Breadcrumb">
      <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
          <%= link_to purchases_path, class: "inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600" do %>
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
            </svg>
            Compras
          <% end %>
        </li>
        <li aria-current="page">
          <div class="flex items-center">
            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
            </svg>
            <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">
              <%= @purchase.new_record? ? "Nueva Compra" : "Editar Compra ##{@purchase.id}" %>
            </span>
          </div>
        </li>
      </ol>
    </nav>

    <%= form_with model: @purchase, local: true, data: { controller: "purchase-items" }, class: "space-y-6" do |f| %>
      
      <!-- Encabezado del formulario -->
      <div class="bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-4 rounded-lg shadow-md">
        <h2 class="text-2xl font-bold">
          <%= @purchase.new_record? ? "Nueva Compra" : "Editar Compra" %>
        </h2>
        <p class="text-green-100 text-sm mt-1">Registra las compras a proveedores</p>
      </div>

      <!-- Mensajes de error -->
      <% if @purchase.errors.any? %>
        <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-4">
          <div class="flex items-start">
            <svg class="w-5 h-5 text-red-500 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div class="flex-1">
              <h4 class="text-red-800 font-semibold mb-2">
                <%= pluralize(@purchase.errors.count, "error") %> impidieron guardar la compra:
              </h4>
              <ul class="list-disc list-inside text-red-700 space-y-1">
                <% @purchase.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          </div>
        </div>
      <% end %>

      <!-- Información General -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
          <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          Información General
        </h3>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <!-- Proveedor -->
          <div>
            <%= f.label :supplier_id, "Proveedor", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= f.collection_select :supplier_id, Supplier.all, :id, :name, 
                { prompt: "Selecciona un proveedor" }, 
                required: true,
                class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white" %>
          </div>

          <!-- Almacén -->
          <div>
            <%= f.label :warehouse_id, "Almacén", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= f.collection_select :warehouse_id, Warehouse.all, :id, :name, 
                { prompt: "Selecciona un almacén" }, 
                required: true,
                class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent bg-white" %>
          </div>

          <!-- Fecha de Compra -->
          <div>
            <%= f.label :purchase_date, "Fecha de Compra", class: "block text-sm font-medium text-gray-700 mb-2" %>
            <%= f.date_field :purchase_date, 
                required: true,
                value: @purchase.purchase_date || Date.current,
                class: "w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" %>
          </div>
        </div>
      </div>

      <!-- Productos de la Compra -->
      <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="bg-gradient-to-r from-green-50 to-green-100 px-6 py-4 border-b border-gray-200">
          <div class="flex items-center">
            <h3 class="text-lg font-semibold text-gray-800 flex items-center">
              <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"/>
              </svg>
              Productos
            </h3>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                  Producto
                </th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                  Cantidad
                </th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                  Precio Compra
                </th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                  Conversión
                </th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                  Subtotal
                </th>
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider">
                  Costo/Pieza
                </th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-700 uppercase tracking-wider">
                  Acciones
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" data-purchase-items-target="items">
              <%= f.fields_for :purchase_items do |item_fields| %>
                <%= render "purchase_item_fields", f: item_fields %>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Botón agregar producto (abajo para no scrollear) -->
        <div class="px-6 py-3 border-t border-gray-200 bg-white">
          <button type="button" 
                  data-action="purchase-items#addItem"
                  class="inline-flex items-center px-4 py-2 bg-green-600 text-white text-sm font-semibold rounded-lg hover:bg-green-700 transition">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
            </svg>
            Agregar Producto
          </button>
        </div>

        <!-- Total -->
        <div class="bg-gradient-to-r from-green-50 to-green-100 px-6 py-4 border-t border-gray-200">
          <div class="flex justify-end items-center">
            <span class="text-lg font-semibold text-gray-700 mr-3">Total de la Compra:</span>
            <span id="purchase-total" class="text-3xl font-bold text-green-600">$0.00</span>
          </div>
        </div>
      </div>

      <!-- Template para agregar nuevos productos -->
      <template id="purchase-item-template">
        <%= f.fields_for :purchase_items, PurchaseItem.new, child_index: "NEW_RECORD" do |item_fields| %>
          <%= render "purchase_item_fields", f: item_fields %>
        <% end %>
      </template>

      <!-- Nota informativa -->
      <div class="bg-green-50 border border-green-200 rounded-lg p-4">
        <div class="flex items-start">
          <svg class="w-5 h-5 text-green-600 mr-3 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <div class="text-sm text-green-800">
            <p class="font-semibold mb-1">Importante:</p>
            <ul class="list-disc list-inside space-y-1">
              <li>Los subtotales y el total se calculan automáticamente</li>
              <li>El factor de conversión define cuántas unidades de venta contiene cada unidad de compra</li>
              <li>El inventario se actualizará automáticamente al guardar</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Botones de acción -->
      <div class="flex flex-col sm:flex-row gap-3 pt-4">
        <%= f.submit @purchase.new_record? ? "Registrar Compra" : "Actualizar Compra", 
            class: "flex-1 sm:flex-none inline-flex justify-center items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 shadow-md hover:shadow-lg transition duration-200" %>
        
        <%= link_to "Cancelar", 
            purchases_path, 
            class: "flex-1 sm:flex-none inline-flex justify-center items-center px-6 py-3 border border-gray-300 text-base font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-200" %>
      </div>

    <% end %>

  </div>
</div>